PRODUCTION FEATURE: Automatic Collateral Release System

Implement automated collateral return upon successful repayment confirmation.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ARCHITECTURE: Event-Driven Automatic Release

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Borrower Repays â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Repayment Confirmed â”‚ â† On-chain or off-chain
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AUTO TRIGGER EVENT â”‚ â† Database update triggers job
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CollateralReleaseService â”‚
â”‚ - Load REPAYMENT PSBT â”‚
â”‚ - Add platform signature â”‚
â”‚ - Broadcast transaction â”‚
â”‚ - Update loan status â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Collateral Returned â”‚ â† Borrower receives BTC automatically
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

IMPLEMENTATION:

FILE 1: server/services/AutoCollateralReleaseService.ts (NEW)

import { CollateralReleaseService } from './CollateralReleaseService';
import { storage } from '../storage';

export class AutoCollateralReleaseService {

/**

Automatically release collateral when repayment is confirmed

Called by webhook, cron job, or database trigger
*/
static async processRepaidLoans(): Promise<void> {
console.log('[AutoRelease] Checking for repaid loans needing collateral release...');

text
try {
text
  // Find loans that are:
  // 1. Repayment confirmed (status = 'repaid')
  // 2. Collateral not yet released (collateral_released = false)
  // 3. Has funding transaction (fundingTxid exists)
  
  const loans = await storage.db.query(`
    SELECT id, status, collateral_released, funding_txid 
    FROM loans 
    WHERE status = 'repaid' 
      AND collateral_released = false
      AND funding_txid IS NOT NULL
    ORDER BY updated_at ASC
  `);
  
  if (loans.length === 0) {
    console.log('[AutoRelease] No loans pending collateral release');
    return;
  }
  
  console.log(`[AutoRelease] Found ${loans.length} loan(s) pending release`);
  
  // Process each loan
  for (const loan of loans) {
    try {
      console.log(`[AutoRelease] Processing loan ${loan.id}...`);
      
      // Release collateral using pre-signed PSBT
      const txid = await CollateralReleaseService.releaseCollateral(
        loan.id,
        'repayment'  // Use pre-signed REPAYMENT PSBT
      );
      
      // Mark as released
      await storage.db.query(
        'UPDATE loans SET collateral_released = true, collateral_release_txid = ? WHERE id = ?',
        [txid, loan.id]
      );
      
      console.log(`[AutoRelease] âœ… Loan ${loan.id} collateral released: ${txid}`);
      
      // Optional: Send notification to borrower
      await this.notifyBorrower(loan.id, txid);
      
    } catch (error) {
      console.error(`[AutoRelease] âŒ Failed to release loan ${loan.id}:`, error);
      
      // Log error but continue with other loans
      await storage.db.query(
        'UPDATE loans SET collateral_release_error = ? WHERE id = ?',
        [error.message, loan.id]
      );
    }
  }
  
  console.log('[AutoRelease] Batch processing complete');
  
} catch (error) {
  console.error('[AutoRelease] Critical error:', error);
  throw error;
}
}

/**

Process a single loan immediately

Called by API endpoint after repayment confirmation
*/
static async processLoan(loanId: number): Promise<string> {
console.log([AutoRelease] Immediate release triggered for loan ${loanId});

text
const loan = await storage.getLoan(loanId);
text
// Validate loan is ready for release
if (loan.status !== 'repaid') {
  throw new Error(`Loan ${loanId} is not repaid (status: ${loan.status})`);
}

if (loan.collateral_released) {
  throw new Error(`Loan ${loanId} collateral already released`);
}

if (!loan.funding_txid) {
  throw new Error(`Loan ${loanId} has no funding transaction`);
}

// Release collateral
const txid = await CollateralReleaseService.releaseCollateral(
  loanId,
  'repayment'
);

// Update database
await storage.db.query(
  'UPDATE loans SET collateral_released = true, collateral_release_txid = ? WHERE id = ?',
  [txid, loanId]
);

console.log(`[AutoRelease] âœ… Loan ${loanId} released: ${txid}`);

return txid;
}

/**

Notify borrower that collateral has been returned
*/
private static async notifyBorrower(loanId: number, txid: string): Promise<void> {
// Implement notification (email, webhook, in-app notification)
console.log([AutoRelease] ğŸ“§ Notification sent for loan ${loanId});
}
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FILE 2: server/routes.ts (ADD ENDPOINTS)

Add webhook/API endpoint for automatic processing:

// Webhook: Called when repayment is confirmed
app.post('/api/webhooks/repayment-confirmed', async (req, res) => {
try {
const { loanId } = req.body;

text
console.log(`[Webhook] Repayment confirmed for loan ${loanId}`);

// Trigger automatic collateral release
const txid = await AutoCollateralReleaseService.processLoan(loanId);

res.json({ 
  success: true, 
  message: 'Collateral released automatically',
  txid 
});
} catch (error) {
console.error('[Webhook] Error:', error);
res.status(500).json({ error: error.message });
}
});

// Manual trigger endpoint (for admin/testing)
app.post('/api/admin/trigger-auto-release', async (req, res) => {
try {
await AutoCollateralReleaseService.processRepaidLoans();
res.json({ success: true, message: 'Auto-release processing triggered' });
} catch (error) {
console.error('[Admin] Auto-release error:', error);
res.status(500).json({ error: error.message });
}
});

// Immediate release for specific loan (called by UI)
app.post('/api/loans/:id/auto-release', async (req, res) => {
try {
const loanId = parseInt(req.params.id);
const txid = await AutoCollateralReleaseService.processLoan(loanId);

text
res.json({ 
  success: true, 
  message: 'Collateral released',
  txid 
});
} catch (error) {
console.error([API] Auto-release error for loan ${loanId}:, error);
res.status(500).json({ error: error.message });
}
});

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FILE 3: server/cron/autoReleaseCron.ts (NEW - OPTIONAL)

Add scheduled job to periodically check for repaid loans:

import cron from 'node-cron';
import { AutoCollateralReleaseService } from '../services/AutoCollateralReleaseService';

/**

Cron job: Check for repaid loans every 5 minutes

Automatically release collateral for confirmed repayments
/
export function startAutoReleaseCron() {
// Run every 5 minutes
cron.schedule('/5 * * * *', async () => {
console.log('[Cron] Auto-release check started');

try {
await AutoCollateralReleaseService.processRepaidLoans();
} catch (error) {
console.error('[Cron] Auto-release failed:', error);
}
});

console.log('[Cron] Auto-release scheduler started (every 5 minutes)');
}

// Add to server startup:
// In server/index.ts:
// import { startAutoReleaseCron } from './cron/autoReleaseCron';
// startAutoReleaseCron();

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FILE 4: Update Database Schema

Add columns to track automatic release:

ALTER TABLE loans ADD COLUMN collateral_released BOOLEAN DEFAULT false;
ALTER TABLE loans ADD COLUMN collateral_release_txid VARCHAR(64);
ALTER TABLE loans ADD COLUMN collateral_release_error TEXT;
ALTER TABLE loans ADD COLUMN collateral_released_at TIMESTAMP;

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FILE 5: Update CollateralReleaseService.ts

Ensure it returns txid and updates properly:

export class CollateralReleaseService {

static async releaseCollateral(
loanId: number,
scenario: 'repayment' | 'default' | 'liquidation'
): Promise<string> {

text
console.log(`[CollateralRelease] Processing ${scenario} for loan ${loanId}`);

const loan = await storage.getLoan(loanId);

if (!loan.funding_txid) {
  throw new Error('Loan not funded - no UTXO to spend');
}

if (scenario === 'repayment') {
  // Use pre-signed REPAYMENT PSBT
  return await this.tryPreSignedRelease(loanId);
}

// For DEFAULT/LIQUIDATION (after hybrid refactor)
return await this.buildDynamicRelease(loanId, scenario);
}

private static async tryPreSignedRelease(loanId: number): Promise<string> {
console.log([PRE-SIGNED] Starting pre-signed release for loan ${loanId});

text
// Load REPAYMENT PSBT
const psbts = await storage.getPreSignedTransactions(loanId);
const repaymentPsbt = psbts.find(p => p.tx_type === 'repayment');

if (!repaymentPsbt || !repaymentPsbt.signature) {
  throw new Error('No pre-signed REPAYMENT PSBT found');
}

const loan = await storage.getLoan(loanId);

// Decode PSBT
const psbt = bitcoin.Psbt.fromBase64(repaymentPsbt.psbt);

// Update with real UTXO
psbt.updateInput(0, {
  witnessUtxo: {
    script: Buffer.from(loan.witnessScript, 'hex'),
    value: loan.collateralSats
  }
});

// Verify borrower's signature exists
console.log('[PRE-SIGNED] Borrower signature verified âœ“');

// Add platform signature
const platformKey = ECPair.fromPrivateKey(
  Buffer.from(process.env.PLATFORM_SIGNING_KEY, 'hex')
);

psbt.signInput(0, platformKey);

// Finalize and extract
psbt.finalizeAllInputs();
const tx = psbt.extractTransaction();
const txHex = tx.toHex();
const txid = tx.getId();

console.log(`[PRE-SIGNED] Transaction finalized: ${txid}`);

// Broadcast
await this.broadcastTransaction(txHex);

console.log(`[PRE-SIGNED] âœ… Transaction broadcast successful: ${txid}`);

// Update PSBT status
await storage.db.query(
  'UPDATE pre_signed_transactions SET broadcast_status = ?, broadcast_txid = ?, broadcasted_at = NOW() WHERE id = ?',
  ['broadcast', txid, repaymentPsbt.id]
);

return txid;
}

private static async broadcastTransaction(txHex: string): Promise<void> {
// Implement broadcast to Bitcoin network
// Use blockstream API, your own node, etc.
const response = await fetch(
'https://blockstream.info/testnet4/api/tx',
{
method: 'POST',
body: txHex
}
);

text
if (!response.ok) {
  const error = await response.text();
  throw new Error(`Broadcast failed: ${error}`);
}
}
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FILE 6: Frontend Integration

Update the UI to show automatic release status:

// In loan details page
{loan.status === 'repaid' && !loan.collateral_released && (

<div className="bg-yellow-50 p-4 rounded"> <p className="text-sm text-yellow-800"> â³ Collateral release in progress... Funds will be returned automatically within 5 minutes. </p> </div> )}
{loan.collateral_released && (

<div className="bg-green-50 p-4 rounded"> <p className="text-sm text-green-800"> âœ… Collateral returned successfully! </p> <a href={`https://mempool.space/testnet4/tx/${loan.collateral_release_txid}`} target="_blank" className="text-sm text-blue-600 underline" > View transaction </a> </div> )}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ACTIVATION OPTIONS:

Option 1: Cron-based (Recommended for production)

Runs every 5 minutes automatically

Processes all pending releases in batch

No manual intervention needed

Add: startAutoReleaseCron() to server startup

Option 2: Webhook-based (Real-time)

Triggered immediately when repayment confirmed

Fastest response time

Requires payment processor webhook integration

Option 3: UI-triggered (Hybrid)

"Release Collateral" button in UI

Calls /api/loans/:id/auto-release

Automatic but user-initiated

Good for beta/testing phase

Recommended: Start with Option 3 (UI-triggered), then add Option 1 (cron) for production.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TESTING THE AUTO-RELEASE:

Fix platform key (see Part 1 solution earlier)

Create new test loan

Complete repayment

Trigger auto-release:

Option A: Click "Release Collateral" button (calls auto-release API)

Option B: Wait for cron job (if enabled)

Verify:

Collateral released automatically

Transaction broadcast to blockchain

Database updated (collateral_released = true)

Borrower receives funds

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ERROR HANDLING:

The system includes:
âœ… Key validation before signing
âœ… Error logging to database
âœ… Graceful failure (continues with other loans)
âœ… Manual retry capability
âœ… Transaction status tracking

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

MONITORING:

Add logging/alerts for:

Auto-release success rate

Failed releases (key mismatch, broadcast errors)

Processing time

Pending releases count